#!/usr/bin/env bash
#
#
set -e

help='
Options:

[-i] print system info
[-u] upgrade system
[-n] compile neovim
[-e] explain
[-h] help
'

explain='
General:
Common uses that I do with my system.
If you want a minimal environment create the file ~/.minimal_environment.

-i:
info_manager

-u:
Upgrade the system: apt, pip, flatpak and independent .deb packages

-n:
Build neovim nightly

-e
This

-h
Help
'
source "${HOME}/environment/managers/lib/sys_packages.sh"
source "${HOME}/environment/managers/lib/sys_installers.sh"

info=false
upgrade=false
neovim=false

minimal=false
if [[ -f "$HOME/.minimal_environment" ]]; then
    minimal=true
fi

getopts_executed=false
while getopts "iuenh" opt; do
    case $opt in
    i) info=true ;;
    u) upgrade=true ;;
    n) neovim=true ;;
    e) echo "${explain}" && exit 0 ;;
    h) echo "${help}" && exit 0 ;;
    *) echo "${help}" && exit 1 ;;
    esac
    getopts_executed=true
done

if ! $getopts_executed; then
    echo "No option given..."
    echo "${help}"
    exit 1
fi

print_separator() {
    echo -e "........................."
}

get_root_access() {
    sudo -v
}

install_apt() {
    sudo apt-get -qq update
    sudo apt-get -qq dist-upgrade -y
    sudo apt-get -qq --with-new-pkgs upgrade -y
    sudo apt-get -qq install -y "${apt_common_packages[@]}"
}

install_pip() {
    if ! $minimal; then
        curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py
        python3 get-pip.py --user >/dev/null
        pip install -q "${pip_packages[@]}"
        rm -f ./get-pip.py
    else
        sudo apt-get -qq install pipx
        pipx install "${pip_packages[@]}"
    fi
}

install_cargo() {
    cargo install "${cargo_packages[@]}" >/dev/null
}

update_flatpak() {
    sudo flatpak update -y >/dev/null
}

cleanup() {
    sudo apt-get -qq remove --purge -y steam wine
    sudo apt-get -qq autoremove --purge -y

    rm -f "${HOME}/.cache/dmenu_run"
    rm -f "${HOME}/dmenu_cache"
}

install_independent() {
    for inst_function in "${sys_installers[@]}"; do
        echo "   Executing ${inst_function}..."
        "${inst_function}"
    done
}

execute_task() {
    echo "${1}"
    "${2}"
    print_separator
}

if $upgrade; then
    execute_task "Asking for root..." get_root_access

    mkdir -p "$HOME/images/" "$HOME/projects/" "$HOME/bin/"

    execute_task "Updating apt packages..." install_apt

    execute_task "Updating pip packages..." install_pip

    if ! $minimal; then
        sudo apt-get -qq install -y "${apt_full_packages[@]}"
        execute_task "Updating flatpak packages..." update_flatpak
        execute_task "Updating independent packages..." install_independent
        execute_task "Updating cargo packages..." install_cargo
    else
        sudo apt-get -qq install -y "${apt_minimal_packages[@]}"
        dunst_installer
        fzf_installer
    fi

    execute_task "Cleaning up..." cleanup

    echo "Done! Remember to reboot your pc!"

    exit 0
fi

if $info; then
    info_manager
    exit 0
fi

if $neovim; then
    execute_task "Asking for root..." get_root_access
    sudo "$HOME/environment/managers/lib/sys_neovim.sh"
    exit 0
fi
