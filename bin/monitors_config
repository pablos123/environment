#!/usr/bin/env bash
set -Eeuo pipefail

source "${HOME}/environment/lib/helpers.bash"

# --------------------------------------------------
# Constants
# --------------------------------------------------

readonly TMP_CONNECTED_FILE='/tmp/monitors_connected'
readonly POLL_INTERVAL=10

# --------------------------------------------------
# Dependency checks
# --------------------------------------------------

command -v jq >/dev/null || die "jq not found"
command -v xrandr >/dev/null || die "xrandr not found"
command -v i3-msg >/dev/null || die "i3-msg not found"

# --------------------------------------------------
# Functions
# --------------------------------------------------

function get_current_workspace() {
    local w oifs name_focused

    oifs="${IFS}"

    IFS=$'\n'
    for w in $(i3-msg -t get_workspaces | jq -r '.[] | "\(.name)::\(.focused)"'); do
        mapfile -t name_focused < <(echo -e "${w//::/\\n}")
        if [[ "${name_focused[1]}" == "true" ]]; then
            echo "${name_focused[0]}"
            break
        fi
    done
    IFS="${oifs}"
}

function move_workspaces_to_primary() {
    local w oifs current_workspace

    oifs="${IFS}"
    current_workspace="$(get_current_workspace)"

    IFS=$'\n'
    for w in $(i3-msg -t get_workspaces | jq -r .[].name); do
        if [[ "${w}" == "0" ]]; then
            i3-msg workspace "${w}"
            i3-msg move workspace to output nonprimary
            continue
        fi

        i3-msg workspace "${w}"
        i3-msg move workspace to output primary
    done
    IFS="${oifs}"

    i3-msg workspace "${current_workspace}"
}

function configure_monitors() {
    # Notebook
    if [[ "${monitors[*]}" =~ "eDP-1" ]]; then
        if [[ "${monitors[*]}" =~ "HDMI-1" ]]; then
            xrandr --output "HDMI-1" --primary --auto --left-of "eDP-1"
        else
            xrandr --output "eDP-1" --primary --auto
        fi
    # Desk (Deprecated) TODO: reconfigure work machine
    elif [[ "${monitors[*]}" =~ "DisplayPort-2" ]]; then
        if [[ "${monitors[*]}" =~ "HDMI-A-0" ]]; then
            xrandr --output "DisplayPort-2" --primary --auto --right-of "HDMI-A-0"
        else
            xrandr --output "DisplayPort-2" --primary --auto
        fi
    else
        i3-nagbar -m 'Monitors configuration not recognized.' -t warning
    fi

    move_workspaces_to_primary &> /dev/null
    i3-msg restart &>/dev/null
}

mapfile -t monitors < <(xrandr | grep " connected" | awk '{print $1}')

configure_monitors

# --------------------------------------------------
# Daemon mode
# --------------------------------------------------

if [[ "${1:-}" == "-d" ]]; then
    cleanup() { rm -f "${TMP_CONNECTED_FILE}"; }

    echo -n "${monitors[*]}" > "${TMP_CONNECTED_FILE}"

    while true; do
        sleep "${POLL_INTERVAL}"

        mapfile -t monitors < <(xrandr | grep " connected" | awk '{print $1}')

        if [[ "${monitors[*]}" != "$(cat "${TMP_CONNECTED_FILE}")" ]]; then
            configure_monitors
            echo -n "${monitors[*]}" > "${TMP_CONNECTED_FILE}"
        fi
    done
fi
