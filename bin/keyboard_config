#!/usr/bin/env bash
set -Eeuo pipefail

# --------------------------------------------------
# Keyboard configuration
# --------------------------------------------------

readonly REPEAT_DELAY=230
readonly REPEAT_RATE=50
readonly SCREENSAVER_TIMEOUT=900
readonly DPMS_OFF_TIMEOUT=3600
readonly POLL_INTERVAL=10

function configure_keyboard() {
    local options

    options=caps:swapescape

    xset r rate "${REPEAT_DELAY}" "${REPEAT_RATE}"
    xset s "${SCREENSAVER_TIMEOUT}"
    xset dpms 0 0 "${DPMS_OFF_TIMEOUT}"

    # I bought a keyboard with mac's layout (Estaba 60 lucas menos, olvidate)
    # Swap cmd and opt if the keyboard is connected.
    # Give cmd altgr behaviour and opt ctrl.
    # The -option "" at the beginning is for not stacking up the same options
    # for obvious reasons.
    lsusb | grep -q 'Inc. Logi Bolt Receiver' &&
        options="${options},altwin:swap_lalt_lwin,ctrl:ralt_rctrl,lv3:rwin_switch"

    setxkbmap -layout eu -option "" -option "${options}"
}

configure_keyboard

# --------------------------------------------------
# Daemon mode
# --------------------------------------------------

if [[ "${1:-}" == "-d" ]]; then
    while true; do
        sleep "${POLL_INTERVAL}"
        configure_keyboard
    done
fi

