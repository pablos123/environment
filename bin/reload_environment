#!/usr/bin/env bash
set -Eeuo pipefail

# Source shared utilities
source "${HOME}/environment/lib/helpers.bash"

# --------------------------------------------------
# Configuration (constants only)
# --------------------------------------------------
ENVIRONMENT_DIR="${HOME}/environment"
DOTFILES_DIR="${HOME}/.dotfiles_stow"

FILES_TO_REMOVE=(
    "${DOTFILES_DIR}"
    "${HOME}/.bashrc"
    "${HOME}/.profile"
    "${HOME}/.xinitrc"
    "${HOME}/.xprofile"
    "${HOME}/.Xresources"
    "${HOME}/.gtkrc-2.0"
    "${HOME}/.config/gtk-3.0"
)

CACHE_FILES=(
    "${HOME}/rofi-3.runcache"
    "${HOME}/.cache/dmenu_run"
    "${HOME}/dmenu_cache"
)

# --------------------------------------------------
# Remove existing dotfiles
# --------------------------------------------------
rm --recursive --force "${FILES_TO_REMOVE[@]}"

# --------------------------------------------------
# Update environment repository
# --------------------------------------------------
git -C "${ENVIRONMENT_DIR}" pull --ff-only >/dev/null

# --------------------------------------------------
# Copy dotfiles base
# --------------------------------------------------
cp --recursive "${ENVIRONMENT_DIR}/dotfiles" "${DOTFILES_DIR}"

# --------------------------------------------------
# Restow dotfiles
# --------------------------------------------------
cd "${DOTFILES_DIR}" || exit 1
stow --target="${HOME}" --restow -- */

# --------------------------------------------------
# Cleanup caches
# --------------------------------------------------
rm --force "${CACHE_FILES[@]}"

# --------------------------------------------------
# Prefer dark theme for some applications like Zenity
# --------------------------------------------------
# sudo apt install libglib2.0-bin but it's there for default in Debian and
# I do not want to hardcode a lib version.
gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita-dark'
gsettings set org.gnome.desktop.interface icon-theme 'Papirus-Dark'
gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'

# --------------------------------------------------
# Reload desktop components
# --------------------------------------------------
{
    fc-cache --really-force

    kill_and_wait dunst
    kill_and_wait flameshot
    kill_and_wait picom
    picom --daemon &

    quit_and_wait "polybar-msg cmd quit" polybar

    i3-msg restart
} >/dev/null || true

