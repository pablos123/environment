#!/usr/bin/env bash
set -Eeuo pipefail

source "${HOME}/environment/lib/helpers.bash"

# --------------------------------------------------
# Calendar applet
# Opens a calendar popup positioned in the corner
# --------------------------------------------------

readonly CALENDAR_WIDTH=304
readonly CALENDAR_HEIGHT=208

command -v yad >/dev/null || die "yad not found"
command -v xdotool >/dev/null || die "xdotool not found"

previous_calendar=$(xdotool search --onlyvisible --name "Tiny Calendar" || true)

if [[ -n "${previous_calendar}" ]]; then
    xdotool windowclose "${previous_calendar}"
    exit 0
fi

mapfile -t position < <(calculate_applet_position "${CALENDAR_WIDTH}" "${CALENDAR_HEIGHT}" | tr ' ' '\n')

selected_date=$(yad --calendar --title="Tiny Calendar" --date-format="%d-%m-%Y" --width="${CALENDAR_WIDTH}" --height="${CALENDAR_HEIGHT}" --no-buttons --fixed --geometry="+${position[0]}+${position[1]}" 2>/dev/null || true)

[[ -n "${selected_date}" ]] &&
    echo "${selected_date}" | xclip
