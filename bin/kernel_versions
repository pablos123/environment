#!/usr/bin/env bash
set -Eeuo pipefail

source "${HOME}/environment/lib/print_functions.bash"
source "${HOME}/environment/lib/trap_handlers.bash"

# --------------------------------------------------
# Display kernel.org latest releases
# --------------------------------------------------

readonly KERNEL_ORG_URL='https://www.kernel.org'
TMP_FILE="$(mktemp --suffix=.json)"
readonly TMP_FILE

cleanup() {
    rm -f "${TMP_FILE}"
}

command -v curl >/dev/null || die "curl not found"
command -v jq >/dev/null || die "jq not found"

curl --no-progress-meter --output "${TMP_FILE}" "${KERNEL_ORG_URL}/releases.json"

echo -e "\n\e[1;32mLatest Stable:\e[0m\e[1;33m" "$(jq -rM .latest_stable.version "${TMP_FILE}")\e[0m\n"

columns=$(jq -rM '.releases | map(.moniker + "  " + .version  + "  " + .released.isodate) | .[]' "${TMP_FILE}")

echo -e "\e[4;35mMoniker\e[0m  \e[4;35mVersion\e[0m  \e[4;35mDate\e[0m\n${columns}" | column --table
echo -e "\n${KERNEL_ORG_URL}\n"
