#!/usr/bin/env bash

set -ex

original_path="$(pwd)"

function cwd_on_exit_err() {
    cd "${original_path}" || exit 1
    echo "SETUP ERROR" >&2
    exit 1
}

function cwd_on_exit() {
    cd "${original_path}" || exit 1
    exit 0
}

trap cwd_on_exit EXIT
trap cwd_on_exit_err ERR SIGINT SIGTERM

directories=(
    "${HOME}/repos"
    "${HOME}/.base_repos"
    "${HOME}/bin"
    "${HOME}/.local/bin/"
    "${HOME}/playground"
    "${HOME}/images/wallpapers"
    "${HOME}/images/screenshots"
)
mkdir -p "${directories[@]}"

for installer in "${HOME}/environment/lib/installers/"*; do
    command source "${installer}"
done

sudo apt-get autoremove --purge --yes

command -v flatpak &&
    flatpak update -y

# Delete first https clone
if git -C "${HOME}/environment" remote -v | grep -q https; then
    rm -rf "${HOME}/environment"
    git clone "git@github.com:pablos123/environment.git" "${HOME}/environment"
fi

/usr/bin/env bash "${HOME}/environment/bin/reload_environment"

echo "Done! Remember to reboot your pc!"
