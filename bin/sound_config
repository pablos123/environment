#!/usr/bin/env bash
set -Eeuo pipefail

source "${HOME}/environment/lib/print_functions.bash"
source "${HOME}/environment/lib/applet_position.bash"

# --------------------------------------------------
# Sound configuration applet (pavucontrol)
# Case insensitive windows class searching is a pain.
# --------------------------------------------------

readonly PAVUCONTROL_WIDTH=600
readonly PAVUCONTROL_HEIGHT=400

command -v pavucontrol >/dev/null || die "pavucontrol not found"
command -v xdotool >/dev/null || die "xdotool not found"

# Check both case variants (xdotool class search is case-sensitive)
if xdotool search --onlyvisible --class "pavucontrol" 2>/dev/null || xdotool search --onlyvisible --class "Pavucontrol" 2>/dev/null; then
    xdotool search --onlyvisible --class "pavucontrol" windowclose 2>/dev/null ||
        xdotool search --onlyvisible --class "Pavucontrol" windowclose 2>/dev/null || true
    exit 0
fi

pavucontrol -t 3 & disown

while ! xdotool search --onlyvisible --class "pavucontrol" 2>/dev/null && ! xdotool search --onlyvisible --class "Pavucontrol" 2>/dev/null; do
    sleep 0.3
done

read -r pos_x pos_y <<< "$(calculate_applet_position "${PAVUCONTROL_WIDTH}" "${PAVUCONTROL_HEIGHT}")"

xdotool search --onlyvisible --class "pavucontrol" windowsize "${PAVUCONTROL_WIDTH}" "${PAVUCONTROL_HEIGHT}" windowmove "${pos_x}" "${pos_y}" 2>/dev/null ||
    xdotool search --onlyvisible --class "Pavucontrol" windowsize "${PAVUCONTROL_WIDTH}" "${PAVUCONTROL_HEIGHT}" windowmove "${pos_x}" "${pos_y}" 2>/dev/null || true
