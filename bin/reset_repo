#!/usr/bin/env bash
set -Eeuo pipefail

source "${HOME}/environment/lib/helpers.bash"

# --------------------------------------------------
# Reset repository to a single commit
# --------------------------------------------------

readonly BRANCH="${1:-}"
readonly MESSAGE="${2:-reset commit}"

if [[ -z "${BRANCH}" ]] || { [[ "${BRANCH}" != "main" ]] && [[ "${BRANCH}" != "master" ]]; }; then
    die "Usage: reset_repo 'main/master' ['<commit_message>']"
fi

log "Resetting repository to single commit on ${BRANCH}"

git checkout --orphan latest_branch
git add -A
git commit -m "${MESSAGE}"
git branch -D "${BRANCH}"
git branch -m "${BRANCH}"
git push -f origin "${BRANCH}"
git branch --set-upstream-to=origin/"${BRANCH}"

log "Repository reset complete"
