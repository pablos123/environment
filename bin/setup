#!/usr/bin/env bash
set -Eeuo pipefail

# --------------------------------------------------
# Bootstrap functions (before helpers.bash is available)
# --------------------------------------------------

function log() {
    printf '\033[1;32m==>\033[0m %s\n' "${1:-}" >&2
}

function warn() {
    printf '\033[1;33m[WARN]\033[0m %s\n' "${1:-}" >&2
}

function die() {
    printf '\033[1;31m[ERROR]\033[0m %s\n' "${1:-}" >&2
    exit 1
}

# --------------------------------------------------
# Configuration (constants only)
# --------------------------------------------------
ENVIRONMENT_REPO_URL="git@github.com:pablos123/environment.git"
ENVIRONMENT_DIR="${HOME}/environment"
INSTALLERS_DIR="${ENVIRONMENT_DIR}/lib/installers"
RELOAD_SCRIPT="${ENVIRONMENT_DIR}/bin/reload_environment"

NEEDED_DIRECTORIES=(
    "${HOME}/repos"
    "${HOME}/.base_repos"
    "${HOME}/bin"
    "${HOME}/.local/bin"
    "${HOME}/playground"
    "${HOME}/images/wallpapers"
    "${HOME}/images/screenshots"
)

# --------------------------------------------------
# Preconditions
# --------------------------------------------------
if [[ ! -f "${HOME}/.ssh/id_rsa.pub" ]]; then
    die "Missing SSH public key at ~/.ssh/id_rsa.pub"
fi

# --------------------------------------------------
# Clone or update environment repository
# --------------------------------------------------
if [[ ! -d "${ENVIRONMENT_DIR}" ]]; then
    log "Cloning environment repository"
    git clone --quiet "${ENVIRONMENT_REPO_URL}" "${ENVIRONMENT_DIR}"
else
    log "Updating environment repository"
    git -C "${ENVIRONMENT_DIR}" pull --ff-only --quiet
fi

# Source helpers now that environment repo exists
source "${ENVIRONMENT_DIR}/lib/helpers.bash"

# --------------------------------------------------
# Clone additional repositories
# --------------------------------------------------
git_clone_pull_repo "private" "${HOME}/repos/private" false

# --------------------------------------------------
# Directory layout
# --------------------------------------------------
log "Ensuring base directory structure"
mkdir --parents "${NEEDED_DIRECTORIES[@]}" >/dev/null

log "Asking for sudo password"
sudo -v

# --------------------------------------------------
# Run installers (.bash, idempotent, quiet)
# --------------------------------------------------
if [[ ! -d "${INSTALLERS_DIR}" ]]; then
    die "Installers directory not found: ${INSTALLERS_DIR}"
fi

shopt -s nullglob
INSTALLERS=( "${INSTALLERS_DIR}"/*.bash )
shopt -u nullglob

if (( ${#INSTALLERS[@]} > 0 )); then
    log "Running installers"
    for INSTALLER in "${INSTALLERS[@]}"; do
        log
        log "=== Executing: $(basename "${INSTALLER}") ==="
        "${INSTALLER}" >/dev/null
    done
fi

# --------------------------------------------------
# System cleanup
# --------------------------------------------------
log "Running apt autopurge"
sudo apt autopurge --yes >/dev/null

# --------------------------------------------------
# Flatpak update
# --------------------------------------------------
if command -v flatpak >/dev/null; then
    log "Updating Flatpak packages"
    flatpak update --assumeyes >/dev/null
fi

# --------------------------------------------------
# Reload environment
# --------------------------------------------------
if [[ -x "${RELOAD_SCRIPT}" ]]; then
    log "Reloading environment"
    "${RELOAD_SCRIPT}" >/dev/null
else
    warn "${RELOAD_SCRIPT} script not found or not executable"
fi

log
log "Setup completed successfully"
warn "A reboot is recommended"

