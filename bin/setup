#!/usr/bin/env bash
set -Eeuo pipefail

# Source shared utilities
source "${HOME}/environment/lib/print_functions.bash"
source "${HOME}/environment/lib/trap_handlers.bash"

# --------------------------------------------------
# Configuration (constants only)
# --------------------------------------------------
ENVIRONMENT_REPO_URL="git@github.com:pablos123/environment.git"
ENVIRONMENT_DIR="${HOME}/environment"
INSTALLER_DIR="${ENVIRONMENT_DIR}/lib/installers"
RELOAD_SCRIPT="${ENVIRONMENT_DIR}/bin/reload_environment"

# --------------------------------------------------
# Cleanup (only relevant when sourced)
# --------------------------------------------------
function cleanup() {
    unset ENVIRONMENT_REPO_URL ENVIRONMENT_DIR INSTALLER_DIR RELOAD_SCRIPT
    unset installer installers
    unset -f cleanup
}

# --------------------------------------------------
# Preconditions
# --------------------------------------------------
if [[ ! -f "${HOME}/.ssh/id_rsa.pub" ]]; then
    die "Missing SSH public key at ~/.ssh/id_rsa.pub"
fi

# --------------------------------------------------
# Clone or update environment repository
# --------------------------------------------------
if [[ ! -d "${ENVIRONMENT_DIR}" ]]; then
    log "Cloning environment repository"
    git clone --quiet "${ENVIRONMENT_REPO_URL}" "${ENVIRONMENT_DIR}"
else
    log "Updating environment repository"
    git -C "${ENVIRONMENT_DIR}" pull --ff-only --quiet
fi

# --------------------------------------------------
# Directory layout
# --------------------------------------------------
log "Ensuring base directory structure"

mkdir --parents \
    "${HOME}/repos" \
    "${HOME}/.base_repos" \
    "${HOME}/bin" \
    "${HOME}/.local/bin" \
    "${HOME}/playground" \
    "${HOME}/images/wallpapers" \
    "${HOME}/images/screenshots" \
    >/dev/null

log "Asking for sudo password"
sudo -v

# --------------------------------------------------
# Run installers (.bash, idempotent, quiet)
# --------------------------------------------------
if [[ ! -d "${INSTALLER_DIR}" ]]; then
    die "Installer directory not found: ${INSTALLER_DIR}"
fi

shopt -s nullglob
installers=( "${INSTALLER_DIR}"/*.bash )
shopt -u nullglob

if (( ${#installers[@]} > 0 )); then
    log "Running installers"
    for installer in "${installers[@]}"; do
        log "Executing installer: $(basename "${installer}")"
        "${installer}" >/dev/null
    done
fi

# --------------------------------------------------
# System cleanup
# --------------------------------------------------
log "Running apt autopurge"
sudo apt autopurge --yes >/dev/null

if command -v flatpak >/dev/null; then
    log "Updating Flatpak packages"
    flatpak update --assumeyes >/dev/null
fi

# --------------------------------------------------
# Reload environment
# --------------------------------------------------
if [[ -x "${RELOAD_SCRIPT}" ]]; then
    log "Reloading environment"
    "${RELOAD_SCRIPT}" >/dev/null
else
    warn "${RELOAD_SCRIPT} script not found or not executable"
fi

log "Setup completed successfully"
warn "A reboot is recommended"

