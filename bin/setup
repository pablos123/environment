#!/usr/bin/env bash
set -Eeuo pipefail

# --------------------------------------------------
# Configuration (constants only)
# --------------------------------------------------
ENVIRONMENT_REPO_URL="git@github.com:pablos123/environment.git"
ENVIRONMENT_DIR="${HOME}/environment"
INSTALLER_DIR="${ENVIRONMENT_DIR}/lib/installers"
RELOAD_SCRIPT="${ENVIRONMENT_DIR}/bin/reload_environment"

ORIGINAL_PWD="$(pwd)"

# --------------------------------------------------
# Helpers (only our messages)
# --------------------------------------------------
function log() {
    printf '\033[1;32m==>\033[0m %s\n' "${1}"
}

function warn() {
    printf '\033[1;33m[WARN]\033[0m %s\n' "${1}"
}

function die() {
    printf '\033[1;31m[ERROR]\033[0m %s\n' "${1}" >&2
    exit 1
}

# --------------------------------------------------
# Cleanup (only relevant when sourced)
# --------------------------------------------------
function cleanup() {
    unset ENVIRONMENT_REPO_URL ENVIRONMENT_DIR INSTALLER_DIR RELOAD_SCRIPT ORIGINAL_PWD
    unset installer installers
    unset -f log warn die on_error on_exit cleanup
}

# --------------------------------------------------
# Traps
# --------------------------------------------------
function on_error() {
    local exit_code="${?}"
    cd "${ORIGINAL_PWD}" || true
    printf '\033[1;31m[ERROR]\033[0m Setup failed (exit code %s)\n' "${exit_code}" >&2

    exit "${exit_code}"
}

function on_exit() {
    cd "${ORIGINAL_PWD}" || true
    cleanup
}

trap on_error ERR SIGINT SIGTERM
trap on_exit EXIT

# --------------------------------------------------
# Preconditions
# --------------------------------------------------
if [[ ! -f "${HOME}/.ssh/id_rsa.pub" ]]; then
    die "Missing SSH public key at ~/.ssh/id_rsa.pub"
fi

# --------------------------------------------------
# Clone or update environment repository
# --------------------------------------------------
if [[ ! -d "${ENVIRONMENT_DIR}" ]]; then
    log "Cloning environment repository"
    git clone "${ENVIRONMENT_REPO_URL}" "${ENVIRONMENT_DIR}" >/dev/null
else
    log "Updating environment repository"
    git -C "${ENVIRONMENT_DIR}" pull --ff-only >/dev/null
fi

# --------------------------------------------------
# Directory layout
# --------------------------------------------------
log "Ensuring base directory structure"

mkdir --parents \
    "${HOME}/repos" \
    "${HOME}/.base_repos" \
    "${HOME}/bin" \
    "${HOME}/.local/bin" \
    "${HOME}/playground" \
    "${HOME}/images/wallpapers" \
    "${HOME}/images/screenshots" \
    >/dev/null

# --------------------------------------------------
# Run installers (.bash, idempotent, quiet)
# --------------------------------------------------
if [[ ! -d "${INSTALLER_DIR}" ]]; then
    die "Installer directory not found: ${INSTALLER_DIR}"
fi

shopt -s nullglob
installers=( "${INSTALLER_DIR}"/*.bash )
shopt -u nullglob

if (( ${#installers[@]} > 0 )); then
    log "Running installers"
    for installer in "${installers[@]}"; do
        log "Sourcing installer: $(basename "${installer}")"
        # shellcheck source=/dev/null
        source "${installer}" >/dev/null
    done
fi

# --------------------------------------------------
# System cleanup
# --------------------------------------------------
log "Running apt autopurge"
sudo apt autopurge --yes >/dev/null

if command -v flatpak >/dev/null; then
    log "Updating Flatpak packages"
    flatpak update --assumeyes >/dev/null
fi

# --------------------------------------------------
# Reload environment
# --------------------------------------------------
if [[ -x "${RELOAD_SCRIPT}" ]]; then
    log "Reloading environment"
    ./"${RELOAD_SCRIPT}" >/dev/null
else
    warn "${RELOAD_SCRIPT} script not found or not executable"
fi

log "Setup completed successfully"
warn "A reboot is recommended"

