#!/usr/bin/env bash
set -Eeuo pipefail

# --------------------------------------------------
# Battery low notification
# Notify if a battery is low to prevent unexpected shutdowns.
# --------------------------------------------------

readonly LOW_BATTERY_THRESHOLD=16
readonly POLL_INTERVAL=10

# --------------------------------------------------
# Dependency checks
# --------------------------------------------------

command -v upower >/dev/null || die "upower not found"
command -v notify-send >/dev/null || die "notify-send not found"

# --------------------------------------------------
# Functions
# --------------------------------------------------

function is_battery() {
    local data_filtered

    mapfile -t data_filtered < <(echo "$1" | awk '/present:|model:|rechargeable:|voltage:/{print $2}' | tr -d %)


    [[ -z "${data_filtered[0]:-}" ]] ||
    [[ -z "${data_filtered[1]:-}" ]] ||
    [[ -z "${data_filtered[2]:-}" ]] ||
    [[ -z "${data_filtered[3]:-}" ]] &&
        return 1
    return 0
}

function battery_notify() {
    local state model percentage battery_data data_filtered

    for battery in $(upower --enumerate); do
        battery_data="$(upower --show-info "${battery}")"

        ! is_battery "${battery_data}" &&
            continue

        mapfile -t data_filtered < <(echo "${battery_data}" | awk '/model:|state:|percentage:/{print $2}' | tr -d %)

        state="${data_filtered[1]}"
        [[ "${state}" != "discharging" ]] &&
            continue

        percentage="${data_filtered[2]}"
        if [[ ${percentage} -lt ${LOW_BATTERY_THRESHOLD} ]]; then
            model="${data_filtered[0]}"
            notify-send --urgency "critical" --expire-time="$(( POLL_INTERVAL * 1000 ))" "LOW BATTERY" "\n${model}: ${percentage}%"
        fi
    done
}

battery_notify

# --------------------------------------------------
# Daemon mode
# --------------------------------------------------

if [[ "${1:-}" == "-d" ]]; then
    while true; do
        sleep "${POLL_INTERVAL}"
        battery_notify
    done
fi
