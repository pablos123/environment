#!/usr/bin/env bash
# I don't watch all the time my status bar, sometimes I don't see the battery is low and the pc shuts down.
# Notify if a battery is low.

function battery_notify() {
    local black_list state model percentage data
    black_list=(
        DisplayDevice
        line_power_ADP0
    )

    for battery in $(upower -e); do
        [[ "${black_list[*]}" =~ ${battery} ]] || [[ ! "${battery}" =~ battery ]] &&
            continue

        mapfile -t data < <(upower -i /org/freedesktop/UPower/devices/battery_BAT0 | awk '/model:|state:|percentage:/{print $2}' | tr -d %)

        state="${data[1]}"
        [[ "${state}" != "discharging" ]] &&
            continue

        percentage="${data[2]}"
        if [[ ${percentage} -lt 16 ]]; then
            model="${data[0]}"
            notify-send --urgency "critical" --expire-time=600000 "LOW BATTERY" "\n${model}: ${percentage}%"
        fi
    done
}

battery_notify

if [[ "${1}" == "-d" ]]; then
    while true; do
        sleep 10
        battery_notify
    done
fi
