#!/usr/bin/env bash
# I don't watch all the time my status bar, sometimes I don't see the battery is low and the pc shuts down.
# Notify if a battery is low.
#
function is_battery() {
    local data_filtered

    mapfile -t data_filtered < <(echo "$1" | awk '/present:|model:|rechargeable:|voltage:/{print $2}' | tr -d %)


    [[ -z "${data_filtered[0]}" ]] ||
    [[ -z "${data_filtered[1]}" ]] ||
    [[ -z "${data_filtered[2]}" ]] ||
    [[ -z "${data_filtered[3]}" ]] &&
        return 1
    return 0
}

function battery_notify() {
    local state model percentage battery_data data_filtered

    for battery in $(upower -e); do
        battery_data="$(upower -i "${battery}")"

        ! is_battery "${battery_data}" &&
            continue

        mapfile -t data_filtered < <(echo "${battery_data}" | awk '/model:|state:|percentage:/{print $2}' | tr -d %)

        state="${data_filtered[1]}"
        [[ "${state}" != "discharging" ]] &&
            continue

        percentage="${data_filtered[2]}"
        if [[ ${percentage} -lt 16 ]]; then
            model="${data_filtered[0]}"
            notify-send --urgency "critical" --expire-time=600000 "LOW BATTERY" "\n${model}: ${percentage}%"
        fi
    done
}

battery_notify

if [[ "${1}" == "-d" ]]; then
    while true; do
        sleep 10
        battery_notify
    done
fi
