#!/usr/bin/env bash
# I don't watch all the time my status bar, sometimes I don't see the battery is low and the pc shuts down.
# Notify if a battery is low.

function battery_notify() {
    local state model percentage is_battery data

    for battery in $(upower -e); do

        mapfile -t is_battery < <(upower -i "${battery}" | awk '/present:|model:|rechargeable:|voltage:/{print $2}' | tr -d %)

        [[ -z "${is_battery[0]}" ]] ||
        [[ -z "${is_battery[1]}" ]] ||
        [[ -z "${is_battery[2]}" ]] ||
        [[ -z "${is_battery[3]}" ]] &&
            continue

        mapfile -t data < <(upower -i "${battery}" | awk '/model:|state:|percentage:/{print $2}' | tr -d %)

        state="${data[1]}"
        [[ "${state}" != "discharging" ]] &&
            continue

        percentage="${data[2]}"
        if [[ ${percentage} -lt 16 ]]; then
            model="${data[0]}"
            notify-send --urgency "critical" --expire-time=600000 "LOW BATTERY" "\n${model}: ${percentage}%"
        fi
    done
}

battery_notify

if [[ "${1}" == "-d" ]]; then
    while true; do
        sleep 10
        battery_notify
    done
fi
