#!/usr/bin/env bash
set -Eeuo pipefail

# --------------------------------------------------
# Configuration (constants only)
# --------------------------------------------------
TARGET_USER="pab"
MOUNT_BASE="/media/${TARGET_USER}"
SETUP_URL="https://raw.githubusercontent.com/pablos123/environment/refs/heads/main/bin/setup"

ORIGINAL_PWD="$(pwd)"

# --------------------------------------------------
# Helpers (only our messages)
# --------------------------------------------------
function log() {
    printf '\033[1;32m==>\033[0m %s\n' "${1}"
}

function warn() {
    printf '\033[1;33m[WARN]\033[0m %s\n' "${1}"
}

function die() {
    printf '\033[1;31m[ERROR]\033[0m %s\n' "${1}" >&2
    exit 1
}

# --------------------------------------------------
# Cleanup
# --------------------------------------------------
function cleanup() {
    :
}

# --------------------------------------------------
# Traps
# --------------------------------------------------
function on_error() {
    local exit_code="${?}"
    cd "${ORIGINAL_PWD}" || true
    printf '\033[1;31m[ERROR]\033[0m Post-install setup failed (exit code %s)\n' "${exit_code}" >&2
    exit "${exit_code}"
}

function on_exit() {
    cd "${ORIGINAL_PWD}" || true
    cleanup
}

trap on_error ERR SIGINT SIGTERM
trap on_exit EXIT

# --------------------------------------------------
# Preconditions
# --------------------------------------------------
function require_root() {
    if [[ "${EUID}" -ne 0 ]]; then
        die "Run this script as root"
    fi
}

require_root

log "Starting Debian headless post-install setup"

# --------------------------------------------------
# Required inputs
# --------------------------------------------------
log "Asking for /dev/sdxn"

read -r -p "In which device partition is the passwords.kdbx file?: (sdxn) " sdxn

if [[ -z "${sdxn}" ]]; then
    die "Empty sdxn"
fi

if [[ ! -e "/dev/${sdxn}" ]]; then
    die "/dev/${sdxn} does not exist"
fi

log "Asking if it is work"

read -r -p "Is this setup for work?: (yes/no) " is_work

log "Asking for keepassxc vault password"

read -rs -p "Insert keepassxc vault password: " vault_pass

# --------------------------------------------------
# APT: Remove cdrom entries
# --------------------------------------------------
log "Removing cdrom entries from APT sources"

sed --in-place '/^deb cdrom:/d' /etc/apt/sources.list || true

if [[ -d /etc/apt/sources.list.d ]]; then
    sed --in-place '/^deb cdrom:/d' /etc/apt/sources.list.d/*.list >/dev/null || true
fi

log "Updating package lists"
apt update >/dev/null

# --------------------------------------------------
# Networking: switch fully to NetworkManager
# --------------------------------------------------
log "Installing NetworkManager"
apt install --yes network-manager >/dev/null

log "Disabling legacy ifupdown networking"
rm --force /etc/network/interfaces

systemctl disable networking.service &>/dev/null || true
systemctl stop networking.service &>/dev/null || true

apt purge --yes ifupdown >/dev/null || true

log "Enabling NetworkManager"
systemctl enable NetworkManager >/dev/null
systemctl restart NetworkManager >/dev/null

# --------------------------------------------------
# Base packages
# --------------------------------------------------
log "Installing base packages"
apt install --yes \
    git \
    sudo \
    ntfs-3g \
    rfkill \
    curl \
    keepassxc \
    >/dev/null

# --------------------------------------------------
# User configuration
# --------------------------------------------------
log "Granting sudo access to ${TARGET_USER}"
usermod --append --groups sudo "${TARGET_USER}" >/dev/null

# --------------------------------------------------
# Mount points
# --------------------------------------------------
log "Creating mount directories"
mkdir --parents \
    "${MOUNT_BASE}/usb1" \
    "${MOUNT_BASE}/usb2" \
    "${MOUNT_BASE}/usb3" \
    >/dev/null

# --------------------------------------------------
# APT warnings
# --------------------------------------------------
log "Removing apt unstable cli interface warning"
echo "Apt::Cmd::Disable-Script-Warning true;" | tee /etc/apt/apt.conf.d/90disablescriptwarning

# --------------------------------------------------
# SSH keys
# --------------------------------------------------
log "Creating /home/pab/.ssh directory "
mkdir -p /home/pab/.ssh

MOUNT_POINT="${MOUNT_BASE}/usb1"
if [[ -n "$( ls -A "${MOUNT_POINT}" )" ]]; then
    die "${MOUNT_POINT} directory not empty"
fi

mount "/dev/${sdxn}" "${MOUNT_POINT}"

if [[ "${is_work}" == "yes" ]]; then
    echo "${vault_pass}" | keepassxc-cli --pw-stdin "${MOUNT_POINT}/passwords.kdbx" show -a notes 'SSH Work Priv' > /home/pab/.ssh/id_rsa
    echo "${vault_pass}" | keepassxc-cli --pw-stdin "${MOUNT_POINT}/passwords.kdbx" show -a notes 'SSH Work Public' > /home/pab/.ssh/id_rsa.pub
else
    echo "${vault_pass}" | keepassxc-cli --pw-stdin "${MOUNT_POINT}/passwords.kdbx" show -a notes 'SSH Main Priv' > /home/pab/.ssh/id_rsa
    echo "${vault_pass}" | keepassxc-cli --pw-stdin "${MOUNT_POINT}/passwords.kdbx" show -a notes 'SSH Main Public' > /home/pab/.ssh/id_rsa.pub
fi

chmod 0600 /home/pab/.ssh/id_rsa
chmod 0644 /home/pab/.ssh/id_rsa.pub

chown pab:pab -R /home/pab/.ssh/

# --------------------------------------------------
# Timezone
# --------------------------------------------------
log "Configuring correct timezone"
timedatectl set-timezone America/Argentina/Buenos_Aires

# --------------------------------------------------
# Final instructions
# --------------------------------------------------
log "Post-install setup complete"
warn "Exit the root session and enter as ${TARGET_USER}, then run:"
warn "bash <(curl -fsSL ${SETUP_URL})"

