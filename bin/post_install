#!/usr/bin/env bash

set -euo pipefall

function log() {
    echo -e "\033[1;32m==>\033[0m $1"
}

function warn() {
    echo -e "\033[1;33m[WARN]\033[0m $1"
}

function die() {
    echo -e "\033[1;31m[ERROR]\033[0m $1"
    exit 1
}

function require_root() {
    if [[ "${EUID}" -ne 0 ]]; then
        die "Run this script as root"
    fi
}
require_root

log "Starting Debian headless post-install setup"

# --------------------------------------------------
# APT: Remove cdrom entries
# --------------------------------------------------
log "Removing cdrom entries from APT sources"

sed --in-place '/^deb cdrom:/d' /etc/apt/sources.list || true

if [[ -d /etc/apt/sources.list.d ]]; then
    sed --in-place '/^deb cdrom:/d' /etc/apt/sources.list.d/*.list 2>/dev/null || true
fi

log "Updating package lists"
apt update >/dev/null

# --------------------------------------------------
# Networking: switch fully to NetworkManager
# --------------------------------------------------
log "Installing NetworkManager"
apt install --yes network-manager >/dev/null

log "Disabling ifupdown networking"
# Remove interfaces file
rm -f /etc/network/interfaces

# Disable networking.service if present
systemctl disable networking.service 2>/dev/null || true
systemctl stop networking.service 2>/dev/null || true

apt purge ifupdown >/dev/null

# Enable NetworkManager
log "Enabling NetworkManager networking"
systemctl enable NetworkManager >/dev/null
systemctl restart NetworkManager >/dev/null

log "Installing base packages"
apt install --yes git sudo ntfs-3g rfkill curl >/dev/null

log "Making pab sudo"
usermod -aG sudo pab >/dev/null

log "Creating mount directories"
mkdir --parents /media/pab/usb{1..3}

log "Post-install setup complete."

log "Exit the root session and enter as pab. Then run:"
log "bash <(curl --fail --silent --show-error --location https://raw.githubusercontent.com/pablos123/environment/refs/heads/main/bin/setup_machine)"
